global
daemon
pidfile /var/vcap/sys/run/haproxy_dev/haproxy_dev.pid
maxconn 100000

defaults
mode http
timeout connect 5000ms
timeout client 50000ms
timeout server 50000ms
stats enable
stats uri /admin



# domain in redirect setting - Start
frontend http-in
mode http
bind *:80
acl portalwebuser hdr_beg(host) -i <%= p('web-user-subdomain') %>.
acl portalwebadmin hdr_beg(host) -i <%= p('web-admin-subdomain') %>.
acl portalregistration hdr_beg(host) -i <%= p('web-eureka-subdomain') %>.

use_backend http_server if portalwebuser
use_backend webadmin_servers if portalwebadmin
use_backend eurekaserver_server if portalregistration
# domain in redirect setting - End

backend http_server
mode http
<% link("paas-ta-portal-webuser-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:<%= link('paas-ta-portal-webuser-link').p('server.port') %>
<% end %>

backend webadmin_servers
mode http
<% link("paas-ta-portal-webadmin-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:<%= link('paas-ta-portal-webadmin-link').p('server.port') %>
<% end %>

backend eurekaserver_server
mode http
<% link("paas-ta-portal-registration-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:<%= link('paas-ta-portal-registration-link').p('server.port') %>
<% end %>

listen logapi-in
bind *:5555
mode tcp
<% link("paas-ta-portal-log-api-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:5555
<% end %>


frontend http-in-gatewayserver
mode http
bind *:<%= link('paas-ta-portal-gateway-link').p('server.port') %>
default_backend gatewayserver_server

backend gatewayserver_server
mode http
<% link("paas-ta-portal-gateway-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:<%= link('paas-ta-portal-gateway-link').p('server.port') %>
<% end %>

# MARIA_DB
listen mariadb-in
bind *:<%= link('mariadb-link').p('mariadb.port') %>
mode tcp
<% link("mariadb-link").instances.map do |instance| %>
  server server-<%= instance.index %> <%= instance.address %>:<%= link('mariadb-link').p('mariadb.port') %>
<% end %>



# IP:Port in redirect setting - Start


frontend http-in-8080
mode http
bind *:8080
default_backend http_server

frontend http-in-webadmin
mode http
bind *:<%= link('paas-ta-portal-webadmin-link').p('server.port') %>
default_backend webadmin_servers

frontend http-in-eurekaserver
mode http
bind *:<%= link('paas-ta-portal-registration-link').p('server.port') %>
default_backend eurekaserver_server


# IP:Port in redirect setting - End
